<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1st Line Training Portal</title>
    <link rel="icon" href="data:,">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>

<div class="drag-handle-top"></div>

<div id="login-screen" class="login-page">
  <div class="login-wrapper">
    <div class="login-header">
      <div class="login-brand">
          <img src="icon.svg" alt="Logo" style="height: 60px; vertical-align: middle; margin-right: 10px;">
          1st Line<span>Training</span>
      </div>
      <p>Enter your credentials to access the portal.</p>
    </div>
    
    <div class="login-toggle-wrapper">
      <div class="toggle-btn active" id="btn-admin" onclick="toggleLoginMode('admin')">Trainer / Admin</div>
      <div class="toggle-btn" id="btn-trainee" onclick="toggleLoginMode('trainee')">Trainee</div>
    </div>

    <form onsubmit="event.preventDefault(); attemptLogin();" class="login-form-plain">
        <div class="form-group">
            <label id="lbl-username" for="adminUsername">Username</label>
            <input type="text" id="adminUsername" placeholder="Enter username" class="plain-input" autocomplete="username">
            <input type="text" id="traineeUsername" list="traineeOptions" class="plain-input hidden" placeholder="Search your name..." autocomplete="username">
            <datalist id="traineeOptions"></datalist>
        </div>
        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" placeholder="Enter password" class="plain-input" autocomplete="current-password">
        </div>
        <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px; margin-bottom: 20px;">
            <input type="checkbox" id="rememberMe" style="width: auto; margin: 0; cursor: pointer;">
            <label for="rememberMe" style="margin: 0; cursor: pointer; color: var(--text-muted); font-size: 0.9rem;">Remember Me</label>
        </div>
        <button type="submit" class="btn-primary btn-lg">Sign In</button>
    </form>
    
    <p id="loginError" class="login-error"></p>
  </div>
</div>

<div id="attendanceModal" class="modal-overlay hidden" style="z-index: 4000; background: rgba(0,0,0,0.9);">
    <div class="modal-box">
        <h3><i class="fas fa-clock"></i> Daily Clock In</h3>
        <p style="color:var(--text-muted); margin-bottom:20px;">Please confirm your attendance for today.</p>
        
        <div id="lateReasonSection" class="hidden" style="background:rgba(255, 82, 82, 0.1); padding:15px; border-radius:8px; border:1px solid #ff5252; margin-bottom:20px;">
            <strong style="color:#ff5252; display:block; margin-bottom:10px;">You are clocking in after 08:00 AM.</strong>
            
            <label for="attLateReason">Valid Reason for Lateness</label>
            <textarea id="attLateReason" placeholder="Explain why you are late..." style="height:60px;"></textarea>
            
            <div style="margin-top:10px;">
                <label style="cursor:pointer; display:flex; align-items:center;">
                    <input type="checkbox" id="attInformed" onchange="toggleInformedDetails()" style="width:auto; margin-right:10px;"> 
                    Did you inform a Trainer/Team Leader?
                </label>
            </div>
            
            <div id="attInformedDetails" class="hidden" style="margin-top:10px; padding-left:20px; border-left:2px solid var(--border-color);">
                <label>Platform Used</label><select id="attPlatform"></select>
                <label>Person Informed</label><select id="attContact"></select>
            </div>
        </div>

        <button class="btn-primary btn-lg" style="width:100%;" onclick="submitClockIn()">Confirm Clock In</button>
    </div>
</div>

<div id="bookingModal" class="modal-overlay hidden">
  <div class="modal-box">
    <h3>Confirm Booking</h3>
    <p style="color:var(--text-muted); font-size:0.9rem;" id="bookingDetailsText"></p>
    <label style="font-weight:bold; display:block; margin-bottom:5px;" for="bookingAssessment">Select Assessment:</label>
    <select id="bookingAssessment" style="width:100%; padding:10px; margin-bottom:15px;"></select>
    <div style="display:flex; gap:10px;">
      <button class="btn-secondary" onclick="closeBookingModal()">Cancel</button>
      <button class="btn-primary" onclick="confirmBooking()">Confirm</button>
    </div>
  </div>
</div>

<div id="markingModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 90%; max-width: 1200px;">
        <h3>Assessment Grading / View</h3>
        <div id="markingContainer" style="max-height: 80vh; overflow-y: auto; margin-bottom: 20px;"></div>
        <div style="text-align:right;">
            <button class="btn-secondary" onclick="document.getElementById('markingModal').classList.add('hidden')">Close</button>
            <button class="btn-primary" id="markingSubmitBtn" onclick="submitMarking()">Finalize Score</button>
        </div>
    </div>
</div>

<div id="scheduleModal" class="modal-overlay hidden" style="z-index: 3000;">
  <div class="modal-box" style="width:500px;">
    <h3>Edit Schedule Step</h3>
    <input type="hidden" id="editStepIndex">
    <input type="hidden" id="editStepType">
    
    <label for="editDateRange">Date Range / Duration</label>
    <input type="text" id="editDateRange" placeholder="e.g. 2026/01/06 - 2026/01/07">
    
    <label for="editCourseName">Course Name</label>
    <input type="text" id="editCourseName">
    
    <label for="editMaterialLink">Material Link (Optional)</label>
    <input type="text" id="editMaterialLink" placeholder="http://...">
    <div style="margin-bottom:10px;">
        <label style="cursor:pointer; display:flex; align-items:center;"><input type="checkbox" id="editMaterialAlways" style="width:auto; margin-right:10px;"> Material Always Available (Ignore Date)</label>
    </div>
    
    <div style="margin: 15px 0; padding: 10px; background: var(--bg-input); border-radius: 8px; border: 1px dashed var(--primary);">
        <label style="color:var(--primary); font-weight:bold;">Link Assessment</label>
        
        <label style="font-size:0.8rem;" for="editLinkedTest">Option A: Select from Test Manager</label>
        <select id="editLinkedTest" style="width:100%; margin-bottom:10px;"><option value="">-- None (Use External Link) --</option></select>
        
        <label style="font-size:0.8rem;" for="editAssessmentLink">Option B: External Link (Legacy)</label>
        <input type="text" id="editAssessmentLink" placeholder="http://..." style="margin-bottom:0;">
    </div>

    <div style="display:flex; gap:15px; margin-bottom:10px;">
        <div style="flex:1;">
            <label for="editStartTime">Open Time</label>
            <input type="time" id="editStartTime">
        </div>
        <div style="flex:1;">
            <label for="editEndTime">Close Time</label>
            <input type="time" id="editEndTime">
        </div>
    </div>
    
    <div style="margin-bottom:10px;">
        <label style="cursor:pointer; display:flex; align-items:center;"><input type="checkbox" id="editIgnoreTime" style="width:auto; margin-right:10px;"> Disable Time Restrictions (Open/Close)</label>
    </div>

    <label for="editDueDate">Due Date (YYYY/MM/DD)</label>
    <input type="text" id="editDueDate" placeholder="e.g. 2026/01/07">
    
    <div style="display:flex; gap:10px; margin-top:15px;">
      <button class="btn-secondary" onclick="document.getElementById('scheduleModal').classList.add('hidden')">Cancel</button>
      <button class="btn-primary" onclick="saveScheduleItem()">Save Changes</button>
    </div>
  </div>
</div>

<div id="attendanceAdminModal" class="modal-overlay hidden" style="z-index: 3500;">
    <div class="modal-box" style="width: 800px; max-width: 95%;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3>Attendance Register & Review</h3>
            <button class="btn-secondary btn-sm" onclick="document.getElementById('attendanceAdminModal').classList.add('hidden')"><i class="fas fa-times"></i></button>
        </div>
        <div style="margin-bottom:15px;"><label>Select Group</label><select id="attAdminGroupSelect" onchange="renderAttendanceRegister()"></select></div>
        <div id="attAdminContent" style="max-height:60vh; overflow-y:auto;"></div>
    </div>
</div>

<div id="adminEditModal" class="modal-overlay hidden" style="z-index: 3000;">
    <div class="modal-box">
        <h3 id="adminEditTitle">Edit Item</h3>
        <div id="adminEditContent"></div> <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn-secondary" onclick="document.getElementById('adminEditModal').classList.add('hidden')">Cancel</button>
            <button class="btn-primary" id="adminEditSaveBtn">Save Changes</button>
        </div>
    </div>
</div>

<div id="moveUserModal" class="modal-overlay hidden" style="z-index: 3001;">
    <div class="modal-box">
        <h3 id="moveUserTitle">Move Agent</h3>
        <p>Current Group: <strong id="moveUserCurrent"></strong></p>
        <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:15px;">Moving this agent will automatically update their schedule view to match the new group.</p>
        <label for="moveUserTargetSelect">Select Destination Group</label>
        <select id="moveUserTargetSelect"></select>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-secondary" onclick="document.getElementById('moveUserModal').classList.add('hidden')">Cancel</button>
            <button class="btn-warning" onclick="confirmMoveUser()">Confirm Move</button>
        </div>
    </div>
</div>

<div id="questionnaireModal" class="modal-overlay hidden" style="z-index: 3000;">
    <div class="modal-box" style="width: 600px;">
        <h3>First Time Setup</h3>
        <p style="margin-bottom:15px; color:var(--text-muted);">Please complete the following information to continue.</p>
        <label for="questEmail"><strong>Email Address</strong></label>
        <input type="text" id="questEmail" placeholder="name@example.com">
        <label for="questPhone"><strong>Phone Number</strong></label>
        <input type="text" id="questPhone" placeholder="082 123 4567">
        <label for="questKnowledge"><strong>Knowledge Present Before Training</strong></label>
        <textarea id="questKnowledge" placeholder="Briefly describe your prior experience..." style="height:80px;"></textarea>
        <button class="btn-primary" onclick="saveQuestionnaire()">Save & Continue</button>
    </div>
</div>

<div id="resetModal" class="modal-overlay hidden" style="z-index: 4000;">
    <div class="modal-box" style="border: 2px solid #ff5252;">
        <h3 style="color:#ff5252;">⚠️ Factory Reset</h3>
        <p>This will wipe ALL data from the Cloud Database and this computer.</p>
        <p style="font-size:0.9rem; color:var(--text-muted);">This action cannot be undone.</p>
        
        <label for="resetVerify" style="margin-top:15px;">Type <strong>DELETE</strong> to confirm:</label>
        <input type="text" id="resetVerify" placeholder="DELETE" style="border:1px solid #ff5252;">
        
        <div style="display:flex; gap:10px; margin-top:15px; justify-content:flex-end;">
            <button class="btn-secondary" onclick="closeResetModal()">Cancel</button>
            <button class="btn-danger" onclick="executeFactoryReset()">ERASE EVERYTHING</button>
        </div>
    </div>
</div>

<div id="genericInputModal" class="modal-overlay hidden" style="z-index: 6000;">
    <div class="modal-box" style="max-width: 500px;">
        <h3 id="genericInputTitle">Input Required</h3>
        <p id="genericInputMessage" style="margin-bottom:15px; color:var(--text-muted);"></p>
        <input type="text" id="genericInputValue" style="width:100%; margin-bottom:20px;" autocomplete="off">
        <div style="display:flex; gap:10px; justify-content:flex-end;">
            <button class="btn-secondary" id="btnGenericInputCancel">Cancel</button>
            <button class="btn-primary" id="btnGenericInputConfirm">Confirm</button>
        </div>
    </div>
</div>

<div id="releaseNotesModal" class="modal-overlay hidden" style="z-index: 5000;">
    <div class="modal-box" style="max-width: 600px;">
        <div style="text-align:center; margin-bottom:20px;">
            <i class="fas fa-gift" style="font-size:3rem; color:var(--primary);"></i>
            <h3 id="releaseNotesTitle" style="margin-top:10px;">New Update Installed!</h3>
        </div>
        <div id="releaseNotesContent" style="background:var(--bg-input); padding:15px; border-radius:8px; border:1px solid var(--border-color); margin-bottom:20px; line-height:1.6; max-height: 300px; overflow-y: auto;">
            <!-- Content injected via JS -->
        </div>
        <button class="btn-primary" onclick="document.getElementById('releaseNotesModal').classList.add('hidden')">Awesome!</button>
    </div>
</div>

<div id="activityMonitorModal" class="modal-overlay hidden" style="z-index: 3500;">
    <div class="modal-box" style="width: 95%; max-width: 1400px; height: 90vh; display: flex; flex-direction: column;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3><i class="fas fa-binoculars"></i> Agent Activity Monitor</h3>
            <div style="display:flex; gap:10px;">
                <button class="btn-primary btn-sm" onclick="StudyMonitor.toggleSummary()"><i class="fas fa-chart-pie"></i> Summary / Breakdown</button>
                <button class="btn-warning btn-sm" onclick="StudyMonitor.archiveLog()"><i class="fas fa-archive"></i> Archive/Clear History</button>
                <button class="btn-secondary btn-sm" onclick="closeActivityMonitorModal()"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div id="activityMonitorContent" style="max-height:70vh; overflow-y:auto;"></div>
    </div>
</div>

<!-- STUDY MONITOR OVERLAY -->
<div id="study-overlay" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-app); z-index:6000; display:flex; flex-direction:column;">
    <div style="padding:10px 20px; background:var(--bg-header); border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
        <div style="display:flex; align-items:center; gap:15px;">
            <button id="study-home-btn" class="btn-secondary btn-sm" onclick="StudyMonitor.closeStudyWindow()" title="Home (Return to Schedule)"><i class="fas fa-home"></i> Home</button>
            <button id="study-reload-btn" class="btn-secondary btn-sm" onclick="StudyMonitor.reload()" title="Reload"><i class="fas fa-sync"></i></button>
            <h3 id="study-title" style="margin:0; font-size:1.1rem; color:var(--primary);">Study Material</h3>
        </div>
        <button class="btn-danger btn-sm" onclick="StudyMonitor.closeStudyWindow()">Close & Return</button>
    </div>
    <div id="study-webview-container" style="flex:1; background:#fff;">
        <!-- Webview injected here -->
    </div>
</div>

<div id="urgentNoticeModal" class="modal-overlay hidden" style="z-index: 5000; background: rgba(0,0,0,0.95);">
    <div class="modal-box" style="border: 2px solid #ff5252; max-width: 500px; text-align: center; box-shadow: 0 0 30px rgba(255, 82, 82, 0.3);">
        <i class="fas fa-bullhorn" style="font-size: 3rem; color: #ff5252; margin-bottom: 20px; animation: pulse 2s infinite;"></i>
        <h3 style="color: #ff5252; margin-top: 0; text-transform: uppercase; letter-spacing: 1px;">Urgent Notice</h3>
        <div id="urgentNoticeContent" style="margin: 20px 0; font-size: 1.1rem; line-height: 1.5; text-align: left; background: var(--bg-input); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);"></div>
        <button class="btn-primary btn-lg" id="btnAckNotice" style="width: 100%; background: #ff5252; border-color: #ff5252; color: white;">Acknowledge & Continue</button>
    </div>
</div>

<!-- VISUAL ELEMENTS -->
<div id="toast-container"></div>
<div id="global-loader" class="hidden">
    <div class="spinner"></div>
    <div id="loader-text" style="color:white; font-weight:500; letter-spacing:1px;">Processing...</div>
</div>

<div id="savedReportModal" class="modal-overlay hidden">
    <div class="modal-box" style="width: 210mm; max-width: 95%; max-height: 90vh; overflow-y: auto; background: white; color: black;">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;" class="no-print">
            <h3>Saved Report View</h3>
            <div style="display:flex; gap:10px;">
                <button class="btn-primary" onclick="window.print()">Print</button>
                <button class="btn-secondary" onclick="document.getElementById('savedReportModal').classList.add('hidden')">Close</button>
            </div>
        </div>
        <div id="savedReportContent" class="a4-page" style="box-shadow:none; margin:0 auto;"></div>
    </div>
</div>

<div id="insightReviewModal" class="modal-overlay hidden" style="z-index: 3005;">
    <div class="modal-box">
        <h3>Admin Review Decision</h3>
        <p id="reviewTargetName" style="color:var(--primary); font-weight:bold;"></p>
        <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:15px;">Override the automated status with a manual decision.</p>

        <label for="reviewStatus">Final Status</label>
        <select id="reviewStatus">
            <option value="Pass">Pass (Green)</option>
            <option value="Improvement">Improvement Required (Yellow)</option>
            <option value="Semi-Critical">Semi-Critical (Orange)</option>
            <option value="Critical">Critical (Red)</option>
            <option value="Fail">Definite Fail (Remove)</option>
        </select>

        <label for="reviewComment">Admin Comments</label>
        <textarea id="reviewComment" placeholder="Reasoning for decision..." style="height:100px;"></textarea>

        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn-secondary" onclick="document.getElementById('insightReviewModal').classList.add('hidden')">Cancel</button>
            <button class="btn-primary" onclick="submitInsightReview()">Save Decision</button>
        </div>
    </div>
</div>

<div id="app" class="app-layout" style="display:none;">

  <aside class="sidebar">
    <div class="sidebar-menu">
        <button class="nav-item" onclick="showTab('dashboard-view')" title="Home / Overview">
            <i class="fas fa-home"></i><span class="nav-text">Home</span>
        </button>

        <button class="nav-item admin-only" onclick="showTab('insights')" title="Training Insight">
            <i class="fas fa-brain"></i><span class="nav-text">Training Insight</span>
        </button>

        <button class="nav-item admin-only" onclick="showTab('manage')" title="Add Group">
            <i class="fas fa-user-plus"></i><span class="nav-text">Add Group</span>
        </button>
        <button class="nav-item admin-only" onclick="showTab('capture')" title="Capture Scores">
            <i class="fas fa-edit"></i><span class="nav-text">Capture Scores</span>
        </button>
        <button class="nav-item" onclick="showTab('monthly')" title="Assessment Records">
            <i class="fas fa-table"></i><span class="nav-text">Assessment Records</span>
        </button>
        
        <button class="nav-item admin-only" onclick="showTab('test-records')" title="Test Records">
            <i class="fas fa-tasks"></i><span class="nav-text">Test Records</span>
        </button>
        
        <button class="nav-item admin-only tl-access" onclick="showTab('report-card')" title="Onboard Report">
            <i class="fas fa-file-invoice"></i><span class="nav-text">Onboard Report</span>
        </button>
        
        <button class="nav-item admin-only tl-access" onclick="showTab('agent-search')" title="Agent Search">
            <i class="fas fa-search"></i><span class="nav-text">Agent Search</span>
        </button>
        
        <button class="nav-item" id="nav-live-assessment" onclick="showTab('live-assessment')" title="Live Assessment Booking">
            <i class="fas fa-calendar-check"></i><span class="nav-text">Live Assessment Booking</span>
        </button>

        <button class="nav-item" id="btn-live-exec" onclick="showTab('live-execution')" title="Live Session Arena">
            <i class="fas fa-satellite-dish"></i><span class="nav-text">Live Session Arena</span>
        </button>

        <button class="nav-item" onclick="showTab('assessment-schedule')" title="Schedule">
            <i class="fas fa-list-alt"></i><span class="nav-text">Schedule</span>
        </button>
        
        <button class="nav-item admin-only" onclick="showTab('test-manage')" title="Test Manager">
            <i class="fas fa-clipboard-check"></i><span class="nav-text">Test Engine</span>
        </button>
        <button class="nav-item admin-only" onclick="showTab('vetting-arena')" title="Vetting Test Arena">
            <i class="fas fa-dungeon"></i><span class="nav-text">Vetting Test Arena</span>
        </button>
        <button class="nav-item" id="nav-my-tests" onclick="showTab('my-tests')" title="My Assessments">
            <i class="fas fa-pen-fancy"></i><span class="nav-text">My Assessments</span>
        </button>
        
    </div>
  </aside>

  <main class="content-wrapper">
      
      <header class="top-header">
        <div class="nav-brand"><i class="fas fa-layer-group"></i> 1st Line<span>Training</span></div>
        <div style="display:flex; align-items:center; gap:20px;">
            
            <div class="notif-wrapper" style="position:relative;">
                <button class="icon-btn" onclick="toggleNotifications()" style="position:relative;">
                    <i class="fas fa-bell"></i>
                    <span id="notifBadge" class="badge-count hidden">0</span>
                </button>
                <div id="notificationDropdown" class="notif-dropdown hidden">
                    <div class="notif-header">Notifications</div>
                    <div id="notifList" class="notif-list">
                        <div style="padding:15px; text-align:center; color:#888;">No new notifications</div>
                    </div>
                </div>
            </div>

            <div class="control-bubble">
                <div class="bubble-content">
                    <button id="btn-admin-tools" class="icon-btn admin-only" onclick="showTab('admin-panel')" title="Admin Tools"><i class="fas fa-cogs"></i></button>
                    <button class="icon-btn" onclick="toggleTheme()" title="Toggle Theme"><i class="fas fa-moon"></i></button>
                    <button class="icon-btn" onclick="refreshApp()" title="Refresh"><i class="fas fa-sync-alt"></i></button>
                    <button class="icon-btn logout" onclick="logout()" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
                </div>
                <div class="bubble-handle"><img src="icon.svg" alt="Menu" style="height: 30px;"></div>
            </div>
        </div>
      </header>

      <div class="views-container">

        <section id="dashboard-view"></section>

        <section id="insights" class="admin-only-section">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Training Insight Dashboard</h2>
                <div>
                    <select id="insightGroupFilter" onchange="renderInsightDashboard()" style="width:200px; margin:0;" aria-label="Filter Insight Group">
                        <option value="">Loading Groups...</option>
                    </select>
                </div>
            </div>
            <div id="insightGrid" class="insight-grid">
                <p style="color:var(--text-muted);">Select a group to view insights.</p>
            </div>
        </section>

        <section id="manage" class="admin-only-section">
        <div style="display:flex; justify-content:space-between;"><h2>Manage Groups</h2></div>
        <div class="card grid-2">
            <div>
            <h3>Group Details</h3>
            <div style="margin-bottom:15px; display:flex; gap:15px;">
                <label style="cursor:pointer;"><input type="radio" name="groupMode" value="new" checked onchange="toggleGroupMode()"> Create New</label>
                <label style="cursor:pointer;"><input type="radio" name="groupMode" value="existing" onchange="toggleGroupMode()"> Add to Existing</label>
            </div>
            <div id="groupCreateControls">
                <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:10px;">Duplicate months will automatically be assigned Group A, B, C etc.</p>
                <label for="newGroupYear">Year</label> <select id="newGroupYear"></select>
                <label for="newGroupMonth">Month</label>
                <select id="newGroupMonth">
                    <option value="01">Jan</option><option value="02">Feb</option><option value="03">Mar</option><option value="04">Apr</option>
                    <option value="05">May</option><option value="06">Jun</option><option value="07">Jul</option><option value="08">Aug</option>
                    <option value="09">Sep</option><option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
                </select>
            </div>
            <div id="groupExistControls" class="hidden">
                <label for="addToGroupSelect">Select Existing Group</label>
                <select id="addToGroupSelect"></select>
            </div>
            </div>
            <div>
            <label for="newGroupNames">Trainee Names (One per line)</label>
            <textarea id="newGroupNames" placeholder="e.g. John Doe&#10;Jane Smith"></textarea>
            <button class="btn-primary" onclick="saveRoster()">Process Group & Create Users</button>
            </div>
        </div>
        <div class="card">
            <h3>Existing Groups</h3>
            <ul id="rosterList" style="padding-left:20px; line-height:1.6; color:var(--text-muted);"></ul>
        </div>
        </section>

        <section id="capture" class="admin-only-section">
        <div style="display:flex; justify-content:space-between;"><h2>Capture Scores</h2></div>
        <div class="card grid-4">
            <div><label for="selectedGroup">Group</label><select id="selectedGroup" onchange="loadGroupMembers()"></select></div>
            <div><label for="cycle">Cycle</label><select id="cycle"><option>New Onboard</option><option>Retrain 1</option><option>Retrain 2</option></select></div>
            <div><label for="phase">Phase</label><select id="phase" onchange="handlePhaseChange()"><option>Assessment</option><option>1st Vetting</option><option>Final Vetting</option></select></div>
            <div><label for="assessment">Assessment</label><select id="assessment" onchange="handleAssessmentChange()"></select></div>
            <div><label for="captureDate">Date Completed</label><input type="date" id="captureDate"></div>
            <div id="vettingOptions" class="hidden" style="grid-column: span 4;"><label for="vettingTopic">Vetting Topic</label><select id="vettingTopic"></select></div>
        </div>
        <div class="card">
            <table><thead><tr><th>Trainee</th><th>Score %</th><th>Doc</th><th class="video-col hidden">Video</th></tr></thead><tbody id="captureTable"><tr><td colspan="4">Select group...</td></tr></tbody></table>
            <button class="btn-primary" style="margin-top:20px;" onclick="saveScores()">Submit Scores</button>
        </div>
        </section>

        <section id="monthly">
        <div style="display:flex; justify-content:space-between;"><h2 id="overviewTitle">Fetch Records</h2></div>
        <div class="card">
            <div class="grid-4" id="filterContainer">
            <div id="filterMonthDiv"><label for="filterMonth">Group</label><select id="filterMonth" onchange="renderMonthly()"><option value="">None</option></select></div>
            <div><label for="filterAssessment">Assessment</label><select id="filterAssessment" onchange="renderMonthly()"><option value="">None</option></select></div>
            <div><label for="filterPhase">Phase</label><select id="filterPhase" onchange="renderMonthly()"><option value="">None</option><option>Assessment</option><option>1st Vetting</option><option>Final Vetting</option></select></div>
            <div id="filterTraineeDiv"><label for="filterTrainee">Search Trainee</label><input type="text" id="filterTrainee" placeholder="Name..." onkeyup="renderMonthly()" style="margin-bottom:0;" aria-label="Search Trainee"></div>
            </div>
            <div class="table-responsive">
            <table id="monthlyTableMain">
                <thead><tr><th>Date</th><th>Group</th><th>Trainee</th><th>Assessment</th><th>Phase</th><th>Score</th><th>Status</th></tr></thead>
                <tbody><tr><td colspan="8" class="text-center" style="color:var(--text-muted);">Please select a filter to view records.</td></tr></tbody>
            </table>
            </div>
        </div>
        </section>

        <section id="agent-search" class="admin-only-section">
            <div style="display:flex; justify-content:space-between;"><h2>Agent Search & Overview</h2></div>
            
            <div class="card" style="text-align:center; padding:40px;">
                <i class="fas fa-user-circle" style="font-size:3rem; color:var(--primary); margin-bottom:15px;"></i>
                <div style="max-width:500px; margin:0 auto;">
                    <input type="text" id="agentSearchInput" list="agentSearchList" placeholder="Type Agent Name..." style="font-size:1.2rem; padding:15px; text-align:center; border-radius:30px; border:2px solid var(--border-color);" onchange="performAgentSearch(this.value)">
                    <datalist id="agentSearchList"></datalist>
                    <button class="btn-primary btn-lg" style="margin-top:15px; border-radius:30px; width:200px;" onclick="performAgentSearch(document.getElementById('agentSearchInput').value)">Search</button>
                </div>
            </div>

            <div id="agentSearchResults" class="hidden">
                <!-- Dynamic Content Injected Here -->
            </div>
        </section>

        <section id="test-records" class="admin-only-section">
        <div style="display:flex; justify-content:space-between;"><h2>Vetting Test Submissions</h2></div>
        <div class="card">
            <div class="grid-4">
                <div><label for="filterTestGroup">Group</label><select id="filterTestGroup" onchange="loadTestRecords()"><option value="">All Groups</option></select></div>
                <div><label for="filterTestName">Test Name</label><select id="filterTestName" onchange="loadTestRecords()"><option value="">All Tests</option></select></div>
                <div><label for="filterTestStatus">Status</label><select id="filterTestStatus" onchange="loadTestRecords()"><option value="">All</option><option value="completed">Completed</option><option value="pending_review">Pending Review</option></select></div>
                <div><label for="filterTestTrainee">Search Trainee</label><input type="text" id="filterTestTrainee" placeholder="Search..." onkeyup="loadTestRecords()" style="margin-bottom:0;" aria-label="Search Test Records"></div>
            </div>
            <div class="table-responsive">
            <table id="testRecordsTable">
                <thead><tr><th>Date</th><th>Group</th><th>Trainee</th><th>Test</th><th>Score</th><th>Status</th><th>Action</th></tr></thead>
                <tbody></tbody>
            </table>
            </div>
        </div>
        </section>

        <section id="test-manage" class="admin-only-section">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Test Engine & History</h2>
                <button class="btn-primary" onclick="loadTestBuilder(); showTab('test-builder')">+ Create New Assessment</button>
            </div>
            
            <div class="admin-sub-nav">
                <button class="sub-tab-btn active" onclick="showTestEngineSub('overview', this)">Overview & Manage</button>
                <button class="sub-tab-btn" onclick="showTestEngineSub('history', this)">Completed Assessments (History)</button>
                <button class="sub-tab-btn" onclick="showTestEngineSub('nps', this)">NPS Feedback Config</button>
            </div>

            <div id="engine-view-overview">
                <div class="card">
                    <h3>Assessment Dashboard</h3>
                    <div id="assessmentDashboard">
                        <p style="color:var(--text-muted);">Loading Overview...</p>
                    </div>
                </div>
                <div class="card grid-2">
                    <div><h3>Test List</h3><div id="testListAdmin"></div></div>
                    <div><h3>Grading Queue</h3><div id="markingList"></div></div>
                </div>
            </div>
            
            <div id="engine-view-history" class="hidden">
                <div class="card">
                    <h3>Completed Assessments</h3>
                    <div class="grid-3" style="margin-bottom:15px;">
                        <div><label>Filter by Group</label><select id="historyGroupFilter" onchange="loadCompletedHistory()"><option value="">All</option></select></div>
                        <div><label>Filter by Test</label><select id="historyTestFilter" onchange="loadCompletedHistory()"><option value="">All</option></select></div>
                        <div><label>Search Trainee</label><input type="text" id="historySearch" placeholder="Name..." onkeyup="loadCompletedHistory()" style="margin-bottom:0;"></div>
                    </div>
                    <div class="table-responsive" style="max-height:600px; overflow-y:auto;">
                        <div id="completedHistoryList"></div>
                    </div>
                </div>
            </div>

            <div id="engine-view-nps" class="hidden">
                <div id="npsConfigContainer">
                    <!-- NPS Control Panel injected here -->
                </div>
            </div>
        </section>

        <section id="test-builder" class="admin-only-section">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <button class="btn-secondary" onclick="showTab('test-manage')">&larr; Back to List</button>
                <div>
                    <strong>Total Score: <span id="builderTotalScore">0</span></strong>
                    <button class="btn-primary" onclick="saveTest()">Save Assessment</button>
                </div>
            </div>
            <div class="card">
                <div class="grid-2" style="margin-bottom:20px; border-bottom:1px solid var(--border-color); padding-bottom:20px;">
                    <div>
                        <label for="builderTestType">Test Type</label>
                        <select id="builderTestType">
                            <option value="standard">Standard Assessment (Schedule Based)</option>
                            <option value="vetting">Vetting Test (Timer Based)</option>
                        </select>
                    </div>
                    <div id="durationWrapper" class="hidden">
                        <label for="builderDuration">Duration (Minutes)</label>
                        <input type="number" id="builderDuration" value="30" min="1">
                    </div>
                </div>

                <div style="margin-bottom:20px;">
                    <label id="lblBuilderLink" for="builderAssessmentSelect">Link to Assessment / Subject</label>
                    <select id="builderAssessmentSelect" style="width:100%; padding:10px; font-size:1rem; background:var(--bg-input); color:var(--text-main); border:1px solid var(--border-color); border-radius:8px;"></select>
                    
                    <div id="vettingWrapper" class="hidden">
                        <div style="display:flex; gap:10px;">
                            <select id="builderVettingPhase" style="flex:1; padding:10px; background:var(--bg-input); color:var(--text-main); border:1px solid var(--border-color); border-radius:8px;">
                                <option value="1st Vetting">1st Vetting</option>
                                <option value="Final Vetting">Final Vetting</option>
                            </select>
                            <select id="builderVettingTopic" style="flex:1; padding:10px; background:var(--bg-input); color:var(--text-main); border:1px solid var(--border-color); border-radius:8px;"><option value="">-- Select Topic --</option></select>
                        </div>
                    </div>
                    <input type="text" id="builderCustomTitle" class="hidden" placeholder="Enter Vetting Test Name (e.g. 1st Vetting - Topic)" style="width:100%;">
                </div>
                <div id="questionContainer"></div>
                <div style="margin-top:20px; padding-top:20px; border-top:1px dashed var(--border-color); display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
                    <button class="btn-secondary" onclick="addQuestion('multiple_choice')"><i class="fas fa-dot-circle"></i> Multiple Choice (Radio)</button>
                    <button class="btn-secondary" onclick="addQuestion('multi_select')"><i class="fas fa-check-square"></i> Multiple Answer (Checkbox)</button>
                    <button class="btn-secondary" onclick="addQuestion('text')"><i class="fas fa-font"></i> Text Answer</button>
                    <button class="btn-secondary" onclick="addQuestion('live_practical')"><i class="fas fa-chalkboard-teacher"></i> Live Practical (Instruction)</button>
                    <button class="btn-secondary" onclick="addQuestion('matching')"><i class="fas fa-exchange-alt"></i> Matching / Pairs</button>
                    <button class="btn-secondary" onclick="addQuestion('ranking')"><i class="fas fa-list-ol"></i> Ranking Order</button>
                    <button class="btn-secondary" onclick="addQuestion('matrix')"><i class="fas fa-th"></i> Matrix / Grid</button>
                </div>
            </div>
        </section>

        <section id="vetting-arena">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Vetting Test Arena</h2>
            </div>
            <div id="vetting-arena-content"></div>
        </section>

        <section id="my-tests">
            <h2>My Assessments</h2>
            <div class="card"><div id="myTestsList"></div></div>
        </section>

        <section id="test-take-view">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <button class="btn-secondary" onclick="showTab('my-tests')">Cancel / Exit</button>
                <h3 id="takingTitle" style="margin:0;">Assessment</h3>
            </div>
            <div id="takingQuestions" style="width: 100%; margin: 0;"></div>
            </section>

        <section id="report-card">
        <div class="no-print" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div><h2>Onboard Summary Report</h2></div>
            <div id="report-nav" style="display:flex; gap:10px;">
                <div id="report-sub-nav" style="display:flex; gap:10px;">
                    <button id="btn-rep-new" class="sched-tab-btn active" onclick="showReportSub('create', this)">New Report</button>
                </div>
                <button id="btn-rep-saved" class="sched-tab-btn" onclick="showReportSub('saved', this)">Saved Reports</button>
            </div>
        </div>
        <div id="report-view-create">
            <div class="no-print" style="display:flex; justify-content:flex-end; gap:10px; margin-bottom:10px;">
                <select id="reportTraineeSelect" onchange="generateReport()" style="width:250px; margin:0;" aria-label="Select Trainee for Report"><option value="">-- Select Trainee --</option></select>
                <button class="btn-primary" style="width:auto;" onclick="saveGeneratedReport()"><i class="fas fa-save"></i> Save</button>
                <button class="btn-secondary" style="width:auto;" onclick="window.print()"><i class="fas fa-print"></i> Print / PDF</button>
            </div>
            <div class="a4-page" id="reportContainer">
                <div class="report-header"><div class="report-logo">1st Line Training</div><div class="report-title">Trainee Review Report</div></div>
                <div class="report-row dynamic-section"><div class="report-field half"><label><span class="rep-num"></span>Onboard Name</label><div id="repName" class="report-input-display"></div></div><div class="report-field half"><label>Training Period</label><div id="repPeriod" class="report-input-display"></div></div></div>
                <div class="report-row dynamic-section"><div class="report-field half"><label><span class="rep-num"></span>Contact Information</label><div id="repContact" class="report-input-display" style="min-height:40px;"></div></div><div class="report-field half"><label><span class="rep-num"></span>Knowledge Present Before Training</label><div id="repKnowledge" class="report-input-display" style="min-height:40px;"></div></div></div>
                <div class="report-block dynamic-section"><div class="report-section-title"><span class="rep-num"></span>Training Goal Feedback</div><table class="report-table"><thead><tr><th style="width:60%">Course / Assessment</th><th class="center">Pass</th><th class="center">Improvement</th><th class="center">Failed</th></tr></thead><tbody id="repGoalBody"></tbody></table></div>
                <div class="report-block dynamic-section"><div class="report-section-title"><span class="rep-num"></span>Assessment Scores (Percentage Ranges)</div><table class="report-table"><thead><tr><th style="width:60%">Course / Assessment</th><th class="center">0-59%</th><th class="center">60-89%</th><th class="center">90-100%</th></tr></thead><tbody id="repScoreBody"></tbody></table></div>
                <div class="report-block dynamic-section"><div class="report-field full"><label><span class="rep-num"></span>Were any behavioral problems noticed?</label><div class="check-group"><label><input type="radio" name="repBehavior" value="Yes" onchange="toggleReportDetails('behavior', true)"> Yes</label><label><input type="radio" name="repBehavior" value="No" checked onchange="toggleReportDetails('behavior', false)"> No</label></div></div></div>
                <div id="behaviorDetails" class="hidden-print-field"><div class="report-block dynamic-section"><label class="bold-label"><span class="rep-num"></span>What was the problem & how was it addressed?</label><div class="report-text-area" contenteditable="true" id="repProbText"></div></div><div class="report-block dynamic-section"><label class="bold-label"><span class="rep-num"></span>Proof of problem addressed (Hyperlink)</label><div class="report-input-display" contenteditable="true" placeholder="Paste full URL here..." id="repProbLink"></div></div></div>
                <div class="report-block top-margin dynamic-section"><div class="report-field full"><label><span class="rep-num"></span>Were any training observations made?</label><div class="check-group"><label><input type="radio" name="repObserve" value="Yes" onchange="toggleReportDetails('observe', true)"> Yes</label><label><input type="radio" name="repObserve" value="No" checked onchange="toggleReportDetails('observe', false)"> No</label></div></div></div>
                <div id="observeDetails" class="hidden-print-field"><div class="report-block dynamic-section"><label class="bold-label"><span class="rep-num"></span>What was the observation & how was it addressed?</label><div class="report-text-area" contenteditable="true" id="repObsText"></div></div><div class="report-block dynamic-section"><label class="bold-label"><span class="rep-num"></span>Proof of observation addressed (Hyperlink)</label><div class="report-input-display" contenteditable="true" placeholder="Paste full URL here..." id="repObsLink"></div></div></div>
                <div class="report-block dynamic-section"><div class="report-section-title"><span class="rep-num"></span>Vetting Test Scores (Test 1)</div><table class="report-table"><thead><tr><th>Topic</th><th>0-59%</th><th>60-79%</th><th>80-99%</th><th>100%</th></tr></thead><tbody id="repVetting1Body"></tbody></table></div>
                <div class="report-block dynamic-section"><div class="report-section-title"><span class="rep-num"></span>Vetting Test Scores (Test 2 / Final)</div><table class="report-table"><thead><tr><th>Topic</th><th>0-59%</th><th>60-79%</th><th>80-99%</th><th>100%</th></tr></thead><tbody id="repVetting2Body"></tbody></table></div>
                <div class="report-block dynamic-section"><div class="report-section-title"><span class="rep-num"></span>Pre-Production Feedback (Team Leader)</div><div class="report-text-area" contenteditable="true" id="repFeedback"></div></div>
                <div class="report-block dynamic-section"><div class="report-section-title"><span class="rep-num"></span>Pass-Mark Met</div><div class="report-row"><div class="check-group-block"><label><input type="checkbox" id="repPass1"> Team Leader Feedback Positive</label><label><input type="checkbox" id="repPass2"> Assessment Score Average Pass</label><label><input type="checkbox" id="repPass3"> Vetting Test PassMark Positive</label></div></div></div>
                <div class="report-block dynamic-section"><div class="report-section-title"><span class="rep-num"></span>Deployment Status</div><div class="report-text-area" contenteditable="true" style="height:50px;" id="repDeploy"></div></div>
                <div class="report-footer">Generated via 1st Line Training Portal | Date: <span id="printDate"></span></div>
            </div>
        </div>
        <div id="report-view-saved" class="hidden">
            <div class="card">
                <h3>Saved Reports</h3>
                <input type="text" id="savedReportSearch" placeholder="Search by Trainee Name..." onkeyup="renderSavedReportsList()" aria-label="Search Saved Reports">
                <table style="margin-top:10px;"><thead><tr><th>Date Saved</th><th>Trainee</th><th>Saved By</th><th>Action</th></tr></thead><tbody id="savedReportsList"></tbody></table>
            </div>
        </div>
        </section>

        <section id="live-assessment">
        <div style="display:flex; justify-content:space-between;"><h2>Live Assessment Booking</h2></div>
        <div class="card" style="background:rgba(243, 112, 33, 0.1); border-left:5px solid var(--primary); padding:15px; margin-bottom:20px;">
            <h3 style="margin-top:0; color:#F37021;">Rules of Booking</h3>
            <ul style="margin:0; padding-left:20px; color:var(--text-main);"><li>Trainee is only allowed to book 1 session per hour.</li><li>Do not skip an assessment; rebooking will be difficult.</li><li>Booking times can change depending on the facilitator.</li><li><strong>Cancellation Policy:</strong> Trainees can only cancel 1 session. Further cancellations require Admin approval.</li></ul>
        </div>
        <div class="card admin-only hidden">
            <h3>⚙️ Schedule Settings</h3>
            <div style="display:flex; gap:15px; align-items:flex-end; flex-wrap:wrap;">
                <div style="flex:1; min-width:150px;">
                    <label for="liveStartDate">Start Date</label><input type="date" id="liveStartDate" style="margin-bottom:0;">
                </div>
                <div style="width:100px;"><label for="liveNumDays">Days</label><input type="number" id="liveNumDays" value="7" min="1" style="margin-bottom:0;"></div>
                <button class="btn-primary" onclick="generateLiveTable()" style="width:auto; height:42px;">Update Dates</button>
                <button class="btn-danger" onclick="clearLiveBookings()" style="width:auto; height:42px; margin-left:auto;">Reset All Bookings</button>
            </div>
        </div>
        <div class="card" style="padding:15px; display:flex; align-items:center; gap:10px;">
            <i class="fas fa-search" style="color:var(--text-muted);"></i>
            <input type="text" id="liveBookingSearch" placeholder="Search bookings by Trainee Name or Assessment..." onkeyup="renderLiveTable()" style="margin:0; border:none; background:transparent; font-size:1rem; width:100%;">
        </div>
        <div class="card"><table class="booking-table"><thead><tr><th style="width:20%;">Date</th><th style="width:20%;">1:00 PM</th><th style="width:20%;">2:00 PM</th><th style="width:20%;">3:00 PM</th><th style="width:20%;">4:00 PM</th></tr></thead><tbody id="liveBookingBody"></tbody></table></div>
        </section>

        <section id="assessment-schedule"></section>

        <section id="live-execution">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid var(--border-color); padding-bottom:10px;">
                <h2><i class="fas fa-satellite-dish" style="color:var(--primary);"></i> Live Assessment Arena</h2>
                <button class="btn-secondary btn-sm" onclick="showTab('live-assessment')"><i class="fas fa-arrow-left"></i> Back to Booking</button>
            </div>
            <div id="live-execution-content" style="height: calc(100vh - 150px);"></div>
        </section>

        <section id="admin-panel" class="admin-only-section">
        <div style="display:flex; justify-content:space-between;"><h2>Admin Tools</h2></div>
        
        <div class="admin-sub-nav">
            <button class="sub-tab-btn active" id="btn-sub-users" onclick="showAdminSub('users', this)">Manage Users</button>
            <button class="sub-tab-btn" id="btn-sub-assessments" onclick="showAdminSub('assessments', this)">Training Topics</button>
            <button class="sub-tab-btn" id="btn-sub-data" onclick="showAdminSub('data', this)">Database</button>
            <button class="sub-tab-btn" id="btn-sub-access" onclick="showAdminSub('access', this)">Access Control</button>
            <button class="sub-tab-btn" id="btn-sub-status" onclick="showAdminSub('status', this)">System Status</button>
            <button class="sub-tab-btn" id="btn-sub-updates" onclick="showAdminSub('updates', this)">System Updates</button>
            <button class="sub-tab-btn" id="btn-sub-theme" onclick="showAdminSub('theme', this)">Theme Settings</button> 
        </div>
        
        <div id="admin-view-users" class="admin-view active">
            <div class="card grid-2">
            <div id="admin-create-user-card">
                <h3>Create User</h3>
                <input type="text" id="newUserName" placeholder="Username" aria-label="New Username">
                <select id="newUserRole" aria-label="Select Role"><option value="trainee">Trainee</option><option value="teamleader">Team Leader</option><option value="admin">Admin</option><option value="special_viewer">Special Viewer</option></select>
                <div style="display:flex; gap:5px;"><input type="text" id="newUserPass" placeholder="Password" aria-label="New Password"><button class="btn-secondary" style="width:auto;" onclick="generatePassword()">Gen</button></div>
                <button class="btn-primary" onclick="addUser()">Add User</button>
            </div>
            <div id="admin-user-list-card">
                <h3>Active Users</h3>
                <div id="admin-user-controls" style="margin-bottom:10px; display:flex; justify-content:space-between;">
                    <button class="btn-primary" style="background:#005fa3; padding:5px 10px; font-size:0.8rem;" onclick="scanAndGenerateUsers()"><i class="fas fa-sync"></i> Scan Missing</button>
                    <input type="text" placeholder="Filter..." id="userSearch" style="width:150px; margin:0;" onkeyup="loadAdminUsers()" aria-label="Filter Users">
                </div>
                <div style="max-height:400px; overflow-y:auto;"><table class="admin-table"><thead><tr><th>User</th><th>Role</th><th>Email</th><th>Phone</th><th>Pass</th><th>Act</th></tr></thead><tbody id="userList"></tbody></table></div>
            </div>
            </div>
        </div>

        <div id="admin-view-assessments" class="admin-view">
            <div class="card">
                <h3>Add Assessment</h3>
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                    <input type="text" id="newAssessName" placeholder="Name" aria-label="Assessment Name" style="margin:0; flex:1; min-width:200px;">
                    <label style="white-space:nowrap; cursor:pointer;"><input type="checkbox" id="newAssessVideo"> Video?</label>
                    <label style="white-space:nowrap; cursor:pointer;"><input type="checkbox" id="newAssessLive"> Live?</label>
                    <button class="btn-primary" onclick="addAssessment()" style="width:auto;">Add</button>
                </div>
            </div>
            
            <div class="card">
                <h3>Current Assessments Configuration</h3>
                <div class="grid-3" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px;">
                    <div>
                        <h4 style="border-bottom:2px solid var(--text-muted); padding-bottom:5px; margin-bottom:10px; color:var(--text-main);">Standard Assessments</h4>
                        <div style="max-height:500px; overflow-y:auto; background:var(--bg-input); border-radius:8px; padding:5px;"><table class="admin-table" style="margin:0;"><thead><tr><th>Name</th><th style="width:40px;"></th></tr></thead><tbody id="assessListStandard"></tbody></table></div>
                    </div>
                    <div>
                        <h4 style="border-bottom:2px solid var(--primary); padding-bottom:5px; margin-bottom:10px; color:var(--primary);">Live Assessments</h4>
                        <div style="max-height:500px; overflow-y:auto; background:var(--bg-input); border-radius:8px; padding:5px;"><table class="admin-table" style="margin:0;"><thead><tr><th>Name</th><th style="width:40px;"></th></tr></thead><tbody id="assessListLive"></tbody></table></div>
                    </div>
                    <div>
                        <h4 style="border-bottom:2px solid #9b59b6; padding-bottom:5px; margin-bottom:10px; color:#9b59b6;">Vetting Tests</h4>
                        <div style="max-height:300px; overflow-y:auto; background:var(--bg-input); border-radius:8px; padding:5px; margin-bottom:20px;"><table class="admin-table" style="margin:0;"><thead><tr><th>Name</th><th style="width:40px;"></th></tr></thead><tbody id="assessListVetting"></tbody></table></div>
                        
                        <h4 style="border-bottom:2px solid #9b59b6; padding-bottom:5px; margin-bottom:10px; color:#9b59b6;">Vetting Topics</h4>
                        <div style="display:flex; gap:5px; margin-bottom:10px;">
                            <input type="text" id="newVettingTopic" placeholder="New Topic" aria-label="Vetting Topic Name" style="margin:0; font-size:0.9rem;">
                            <button class="btn-primary btn-sm" onclick="addVettingTopic()" style="width:auto;">Add</button>
                        </div>
                        <ul id="vettingList" class="vetting-list"></ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-view-data" class="admin-view">
            <div class="card grid-2">
            <div>
                <h3>Database Statistics</h3>
                <div id="dbStatsContainer" style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px;"></div>

                <h3>Bulk Actions</h3>
                <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn-warning" onclick="syncGroupsFromRecords()"><i class="fas fa-sync"></i> Sync Groups</button>
                    <button class="btn-secondary" onclick="archiveOldSubmissions()" title="Move old completed tests to archive"><i class="fas fa-archive"></i> Archive Old</button>
                </div>
                
                <div style="margin-bottom:15px; padding-top:10px; border-top:1px solid var(--border-color);">
                    <button class="btn-danger" onclick="deleteBulkRecords()"><i class="fas fa-trash-alt"></i> Delete Selected</button>
                </div>

                <p style="font-size:0.8rem; color:var(--text-muted);">CSV Import</p>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button class="btn-secondary" onclick="downloadCSVTemplate()"><i class="fas fa-file-csv"></i> Template</button>
                <input type="file" id="csvUpload" accept=".csv" style="display:none;" onchange="importCSV(this)" aria-label="Upload CSV">
                <button class="btn-success" onclick="document.getElementById('csvUpload').click()"><i class="fas fa-file-upload"></i> Import</button>
                </div>
                
                <h3>Backup / Restore</h3>
                <div style="margin-bottom:15px; padding:10px; background:var(--bg-input); border:1px solid var(--border-color); border-radius:4px;">
                    <label style="margin:0; cursor:pointer; color:var(--primary);"><input type="checkbox" id="autoBackupToggle" onchange="toggleAutoBackup()" style="width:auto; margin-right:8px;"> Auto-Backup on Save</label>
                </div>
                
                <button class="btn-primary" onclick="exportDatabase()"><i class="fas fa-download"></i> Download JSON</button>
                
                <div style="margin-top:10px; border-top:1px dashed var(--border-color); padding-top:10px;">
                    <input type="file" id="jsonUpload" accept=".json" style="display:none;" onchange="importDatabase(this)" aria-label="Upload JSON Database">
                    <button class="btn-secondary" style="width:100%;" onclick="document.getElementById('jsonUpload').click()"><i class="fas fa-upload"></i> Upload JSON (Restore)</button>
                </div>

                <div style="margin-top:25px; padding-top:15px; border-top:1px solid #ff5252;">
                    <h4 style="color:#ff5252; margin-top:0;">Danger Zone</h4>
                    <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:10px;">Irreversible action. Resets system to factory defaults.</p>
                    <button class="btn-danger" onclick="performCloudFactoryReset()"><i class="fas fa-exclamation-triangle"></i> Factory Reset System</button>
                    <button class="btn-warning" style="margin-top:10px; width:100%;" onclick="resetLiveSessionsKey()"><i class="fas fa-broom"></i> Clear Live Sessions (Fix Lag)</button>
                </div>

            </div>
            <div style="max-height:400px; overflow-y:auto;">
                <h3>Raw Data</h3>
                <input type="text" id="dbSearch" placeholder="Search..." onkeyup="loadAdminDatabase()" aria-label="Search Database">
                <table class="admin-table" style="margin-top:5px;">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllDb" onclick="toggleSelectAll(this)" aria-label="Select All"></th>
                            <th>Trainee</th>
                            <th>Assessment</th>
                            <th>Score</th>
                            <th>Act</th>
                        </tr>
                    </thead>
                    <tbody id="dbTable"></tbody>
                </table>
            </div>
            </div>
        </div>
        
        <div id="admin-view-access" class="admin-view">
            <div class="card grid-2">
            <div>
                <h3>Access Control Settings</h3>
                <p style="margin-bottom:15px;">Restrict portal access to specific IP addresses (e.g. Office or VPN).</p>
                <div style="margin-bottom:20px; padding:15px; background:var(--bg-input); border-radius:8px; border:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                    <div>Status: <span id="acStatus">LOADING...</span></div>
                    <button id="btnToggleAC" class="btn-secondary" onclick="toggleIpRestriction()">Toggle</button>
                </div>
                <label for="newIpInput">Whitelist New IP Address</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="newIpInput" placeholder="e.g. 192.168.0.1">
                    <button class="btn-primary" style="width:auto;" onclick="addIpAddress()">Add</button>
                </div>
                <p style="font-size:0.8rem; color:var(--text-muted); margin-top:10px;"><i class="fas fa-info-circle"></i> If enabled, only IPs listed on the right will be allowed to log in.</p>
            </div>
            <div>
                <h3>Allowed IP List</h3>
                <ul id="ipList" style="list-style:none; padding:0; color:var(--text-main);"></ul>
            </div>
            </div>
        </div>

        <div id="admin-view-status" class="admin-view">
            <div class="grid-2">
                <div class="card">
                    <h3>System Health</h3>
                    <div style="display:flex; gap:20px; margin-bottom:20px;">
                        <div style="flex:1; background:var(--bg-input); padding:15px; border-radius:8px; text-align:center;">
                            <i class="fas fa-database" style="font-size:2rem; color:var(--primary); margin-bottom:10px;"></i>
                            <div style="font-size:0.9rem; color:var(--text-muted);">Storage Used</div>
                            <div id="statusStorage" style="font-size:1.5rem; font-weight:bold;">Loading...</div>
                        </div>
                        <div style="flex:1; background:var(--bg-input); padding:15px; border-radius:8px; text-align:center;">
                            <i class="fas fa-tachometer-alt" style="font-size:2rem; color:#27ae60; margin-bottom:10px;"></i>
                            <div style="font-size:0.9rem; color:var(--text-muted);">Latency</div>
                            <div id="statusLatency" style="font-size:1.5rem; font-weight:bold;">- ms</div>
                        </div>
                    </div>
                    
                    <div style="display:flex; gap:20px; margin-bottom:20px;">
                        <div style="flex:1; background:var(--bg-input); padding:15px; border-radius:8px; text-align:center;">
                            <i class="fas fa-memory" style="font-size:2rem; color:#9b59b6; margin-bottom:10px;"></i>
                            <div style="font-size:0.9rem; color:var(--text-muted);">Memory (Heap)</div>
                            <div id="statusMemory" style="font-size:1.2rem; font-weight:bold;">-</div>
                        </div>
                        <div style="flex:1; background:var(--bg-input); padding:15px; border-radius:8px; text-align:center;">
                            <i class="fas fa-wifi" style="font-size:2rem; color:#3498db; margin-bottom:10px;"></i>
                            <div style="font-size:0.9rem; color:var(--text-muted);">Connection</div>
                            <div id="statusConnection" style="font-size:1.2rem; font-weight:bold;">-</div>
                        </div>
                        <div style="flex:1; background:var(--bg-input); padding:15px; border-radius:8px; text-align:center;">
                            <i class="fas fa-network-wired" style="font-size:2rem; color:#e67e22; margin-bottom:10px;"></i>
                            <div style="font-size:0.9rem; color:var(--text-muted);">Network Latency</div>
                            <div id="statusGateway" style="font-size:1.2rem; font-weight:bold;">-</div>
                        </div>
                    </div>

                    <div style="margin-bottom:20px;">
                        <h4 style="margin-top:0; color:var(--text-muted); font-size:0.9rem;">System Logs</h4>
                        <div id="systemLogList" style="height:150px; overflow-y:auto; background:var(--bg-input); padding:10px; border-radius:8px; font-family:monospace; font-size:0.8rem; color:var(--text-main); border:1px solid var(--border-color);">
                            <div style="color:var(--text-muted);">Initializing logs...</div>
                        </div>
                    </div>

                    <div style="margin-bottom:20px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <h4 style="margin:0; color:var(--text-muted); font-size:0.9rem;">Access Logs (Last 14 Days)</h4>
                            <button class="btn-secondary btn-sm" onclick="refreshAccessLogs()"><i class="fas fa-sync"></i> Refresh Logs</button>
                        </div>
                        <div style="max-height:200px; overflow-y:auto; border:1px solid var(--border-color); border-radius:8px;">
                            <table class="admin-table"><thead><tr><th>Date/Time</th><th>User</th><th>Event</th></tr></thead><tbody id="accessLogTable"></tbody></table>
                        </div>
                    </div>

                    <button class="btn-primary" onclick="refreshSystemStatus()">Refresh Status</button>
                </div>

                <div class="card">
                    <h3>Active Users Monitor</h3>
                    <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:10px;">Real-time view of logged-in users and their activity status.</p>
                    <div class="table-responsive" style="max-height:300px; overflow-y:auto;">
                        <div style="text-align:right; margin-bottom:5px;"><button class="btn-secondary btn-sm" onclick="fetchSystemStatus()"><i class="fas fa-sync"></i> Refresh Monitor</button></div>
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Ver</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Idle Time</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="activeUsersTable">
                                <tr><td colspan="6" class="text-center">Loading active users...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-view-updates" class="admin-view">
            <div class="card" style="text-align:center; max-width:600px; margin:40px auto;">
                <img src="icon.svg" style="height:80px; margin-bottom:20px;">
                <h3>System Updates</h3>
                
                <div id="updateStatusContainer" style="margin:20px 0;">
                    <div style="font-size:0.9rem; color:var(--text-muted); margin-bottom:5px;">Current Version</div>
                    <div id="currentVersionDisplay" style="font-size:1.5rem; font-weight:bold; color:var(--primary); margin-bottom:20px;">Loading...</div>
                    
                    <button id="btnCheckUpdates" class="btn-primary btn-lg" onclick="triggerManualUpdate()"><i class="fas fa-sync"></i> Check for Updates</button>
                    <button id="btnInstallUpdate" class="btn-success btn-lg hidden" onclick="restartAndInstall()"><i class="fas fa-arrow-circle-up"></i> Restart & Install</button>
                </div>

                <div id="updateProgressContainer" class="hidden" style="background:var(--bg-input); padding:20px; border-radius:12px; border:1px solid var(--border-color); text-align:left;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:bold;">
                        <span id="updateStatusText" style="color:var(--primary);">Downloading...</span>
                        <span id="updateProgressText">0%</span>
                    </div>
                    <div class="progress-track" style="height:12px; margin:0;">
                        <div id="updateProgressBar" class="progress-fill" style="width:0%;"></div>
                    </div>
                    <p style="font-size:0.8rem; color:var(--text-muted); margin-top:10px; text-align:center;">Please do not close the application.</p>
                </div>

                <div style="margin-top:20px; text-align:left;">
                    <h4 style="font-size:0.9rem; color:var(--text-muted); border-bottom:1px solid var(--border-color); padding-bottom:5px;">Update Log</h4>
                    <div id="updateLog" style="height:100px; overflow-y:auto; font-family:monospace; font-size:0.8rem; color:var(--text-muted); padding:10px; background:rgba(0,0,0,0.2); border-radius:6px;"></div>
                </div>
            </div>
        </div>

        <div id="admin-view-theme" class="admin-view">
            <div class="card">
                <h3>Personalization</h3>
                <p style="color:var(--text-muted); margin-bottom:20px;">Customize the visual theme for your profile.</p>
                
                <div class="grid-2">
                    <div>
                        <label for="themeColor">Primary Accent Color</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="color" id="themeColor" value="#F37021" style="width:60px; padding:0; height:40px; cursor:pointer;">
                            <span style="font-size:0.9rem; color:var(--text-muted);">Default: Orange (#F37021)</span>
                        </div>
                    </div>
                    <div>
                        <label for="themeWallpaper">Background Wallpaper (URL)</label>
                        <input type="text" id="themeWallpaper" placeholder="https://example.com/image.jpg">
                    </div>
                </div>
                
                <button class="btn-primary" style="width:auto; margin-top:15px;" onclick="saveThemeSettings()">Apply & Save Changes</button>
            </div>

            <div class="card" style="margin-top:20px; border:1px dashed var(--primary);">
                <h3><i class="fas fa-flask" style="color:var(--primary);"></i> Experimental Themes</h3>
                <p style="color:var(--text-muted); margin-bottom:15px;">Try out these auto-generated visual styles. Click 'Reset to Original' to revert.</p>
                
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn-secondary" onclick="applyExperimentalTheme('theme-cyberpunk')" style="border-color:#00f3ff; color:#00f3ff;">Neon Nights</button>
                    <button class="btn-secondary" onclick="applyExperimentalTheme('theme-ocean')" style="border-color:#4fc3f7; color:#4fc3f7;">Deep Sea</button>
                    <button class="btn-secondary" onclick="applyExperimentalTheme('theme-forest')" style="border-color:#76c893; color:#76c893;">Enchanted Forest</button>
                    <button class="btn-secondary" onclick="applyExperimentalTheme('theme-royal')" style="border-color:#9d4edd; color:#9d4edd;">Royal Amethyst</button>
                </div>
                
                <button class="btn-danger" style="margin-top:15px; width:auto;" onclick="applyExperimentalTheme(null)"><i class="fas fa-undo"></i> Reset to Original</button>
            </div>
        </div>

        </section>

      </div> 
  </main>
</div>

<div id="user-footer" class="user-footer"></div>

<script src="js/config.js"></script>
<script src="js/utils.js"></script>
<script src="js/data.js"></script>
<script src="js/auth.js"></script>
<script src="js/dashboard.js"></script> 
<script src="js/admin_updates.js"></script>

<script src="js/admin_sys.js"></script>
<script src="js/admin_users.js"></script>
<script src="js/admin_builder.js"></script> 
<script src="js/vetting_arena.js"></script>
<script src="js/admin_grading.js"></script> <script src="js/schedule.js"></script>
<script src="js/reporting.js"></script>
<script src="js/forms.js"></script> 
<script src="js/insight.js"></script>
<script src="js/assessment_core.js"></script>
<script src="js/assessment_admin.js"></script>
<script src="js/assessment_trainee.js"></script>
<script src="js/live_execution.js"></script>
<script src="js/agent_search.js"></script>
<script src="js/admin_history.js"></script>
<script src="js/attendance.js"></script>
<script src="js/study_monitor.js"></script>
<script src="js/analyticsDashboard.js"></script>
<script src="js/nps_system.js"></script>

<script src="js/main.js"></script>

<script>
// Inline Helper for Select All
function toggleSelectAll(source) {
    const checkboxes = document.querySelectorAll('.db-check');
    for(let i=0; i<checkboxes.length; i++) {
        checkboxes[i].checked = source.checked;
    }
}
</script>